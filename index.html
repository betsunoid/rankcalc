<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ç©ç®—é›»å“ï¼ˆçµ±åˆç‰ˆãƒ»ãƒ©ãƒ³ã‚¯å¯¾å¿œï¼‰</title>
<style>
/* --- CSS START --- */
:root{
--bg:#0b0b0c;
--card:#14171a;
--muted:#9aa4ad;
--accent-1:#1e90ff;
--orange:#ff9500;
--dark-btn:#0b0b0c;
font-family:-apple-system, "Hiragino Kaku Gothic ProN","Yu Gothic","Meiryo",sans-serif;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;background:var(--bg);color:#fff;-webkit-font-smoothing:antialiased}
.app{max-width:820px;margin:8px auto;padding:12px;display:flex;flex-direction:column;gap:12px}
.header{display:flex;justify-content:space-between;align-items:center}
.title{font-weight:800;font-size:18px}
.sub{font-size:13px;color:var(--muted)}

/* top: two-column */
.top{display:flex;gap:12px;align-items:flex-start}
.left{flex:2;background:linear-gradient(180deg,var(--card),#0c0f11);border-radius:12px;padding:10px;min-height:180px;max-height:340px;overflow:auto;border:1px solid rgba(255,255,255,0.03)}
.right{width:240px;background:linear-gradient(180deg,#07080a,#0b0d10);border-radius:12px;padding:12px;border:1px solid rgba(255,255,255,0.04);position:relative}

/* entry */
.entry{display:flex;justify-content:space-between;align-items:center;padding:8px;border-bottom:1px solid rgba(255,255,255,0.02)}
.entry .label{font-weight:700;font-size:15px}
.entry .price{font-variant-numeric:tabular-nums;color:var(--muted);min-width:120px;text-align:right}
.removeBtn{background:transparent;border:0;color:#ff6b6b;font-weight:800;cursor:pointer;margin-left:8px}

/* totals */
.tot-label{font-size:13px;color:var(--muted)}
.tot-value{font-weight:800;font-size:20px;text-align:right;margin-top:4px}

/* buttons */
.grid-wrap{background:transparent;border-radius:12px;padding:8px}
.buttons{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
.btn{
border-radius:12px;
padding:12px 8px;
min-height:64px;
display:flex;
flex-direction:column;
justify-content:center;
align-items:center;
color:var(--dark-btn);
font-weight:800;
border:1px solid rgba(0,0,0,0.1);
box-shadow:0 8px 18px rgba(0,0,0,0.6);
transition:transform .06s;
}
.btn:active{transform:translateY(2px);filter:brightness(0.95)}

/* Cãƒœã‚¿ãƒ³ (æ—¢å­˜ã®æš–è‰²) */
.btn.dark{
background:linear-gradient(180deg, #ff7f50, #ff6347);
color:#fff;
border:1px solid rgba(255,255,255,0.1);
}
/* ACãƒœã‚¿ãƒ³å°‚ç”¨ (ã•ã‚‰ã«æ¿ƒã„æš–è‰²) */
.btn.ac-dark{
background:linear-gradient(180deg, #ff4500, #cc3700);
color:#fff;
border:1px solid rgba(255,255,255,0.2);
}
/* C/ACãƒœã‚¿ãƒ³é…ç½®ã®ãŸã‚ã®ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ */
.btn-placeholder{
background:transparent;
padding:12px 8px;
min-height:64px;
border-radius:12px;
border:1px solid transparent;
}

/* free-group */
.free-group{margin-top:10px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:12px;padding:10px;border:1px solid rgba(255,255,255,0.04);display:flex;flex-direction:column;gap:10px}
.free-row{display:flex;gap:8px;align-items:center}
/* é‡‘é¡å…¥åŠ›æ¬„ã®ã‚¹ã‚¿ã‚¤ãƒ« */
.free-input{flex:1;background:#202327;border:1px solid rgba(255,255,255,0.2);padding:10px;border-radius:8px;text-align:right;color:#fff;font-size:16px}

/* è‡ªç”±å…¥åŠ›ãƒœã‚¿ãƒ³ã®ã‚³ãƒ³ãƒ†ãƒŠã‚¹ã‚¿ã‚¤ãƒ« */
.coeff-row{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-top:10px;padding:0 8px}
/* è‡ªç”±å…¥åŠ›ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
.coeff{
background:#fff;
border:1px solid #fff;
color:var(--dark-btn);
padding:12px 8px;
border-radius:12px;
font-weight:800;
cursor:pointer;
min-height:64px;
display:flex;
flex-direction:column;
justify-content:center;
align-items:center;
text-align:center;
box-shadow:0 8px 18px rgba(0,0,0,0.6);
transition:transform .06s;
}
.coeff:active{transform:translateY(2px);filter:brightness(0.95)}

/* modal - è¨­å®šç”»é¢ã®æ–‡å­—ã¨ãƒœã‚¿ãƒ³ã‚’å¤§ããã™ã‚‹ä¿®æ­£ */
.modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:90;background:linear-gradient(rgba(0,0,0,0.6), rgba(0,0,0,0.6))}
.panel{
width:94%;
max-width:760px;
max-height:86vh;
overflow:auto;
background:#0b0f12;
border-radius:12px;
padding:28px;
border:1px solid rgba(255,255,255,0.04);
font-size:1.2em;
}
.panel h3{
font-size:1.8em;
margin-top:0;
}
.form-row{
display:flex;
gap:16px;
align-items:center;
margin-bottom:16px;
}
.form-row label{
font-size:1.1em;
min-width:180px !important;
color:var(--muted);
}
.form-row input[type="text"], .form-row input[type="number"], .form-row select{
padding:16px;
border-radius:8px;
border:1px solid rgba(255,255,255,0.04);
background:transparent;
color:#fff;
font-size:1.1em;
}

/* è¨­å®šç”»é¢ãƒ˜ãƒƒãƒ€ãƒ¼ç”¨ã®CSS */
.config-header {
display: flex;
gap: 16px;
align-items: center;
margin-bottom: 8px;
padding-left: 36px;
font-size: 1.1em;
}
.config-header > div {
font-weight: 700;
}


/* PC/Tabletã§ã®è¨­å®šå…¥åŠ›æ¬„ã®å¹…æ¯”ç‡èª¿æ•´ */
.form-row #buttonConfig input[type="text"],
.form-row #freeConfig input[type="text"] {
flex-grow: 3;
flex-shrink: 1;
}
.form-row #buttonConfig input[type="number"],
.form-row #freeConfig input[type="number"] {
flex-grow: 2;
flex-shrink: 1;
text-align: right;
}
/* åŸºæœ¬è¨­å®šã®å…¥åŠ›æ¬„ã¯ãƒ•ãƒ«å¹… */
.form-row input[type="number"]#taxInput,
.form-row select#roundMethod {
flex: 1;
}

.small{font-size:13px;color:var(--muted)}

.modal .action-btn{
padding:16px 12px;
font-size:1.1em;
}

/* ãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œã®èª¿æ•´ (iPhoneãªã©ã®ç‹­ã„ç”»é¢) */
@media(max-width:520px){
.right{width:42%}
.btn{min-height:56px;padding:10px}
.entry .price{min-width:90px}

/* è¨­å®šç”»é¢ã®UIè¦ç´ ã‚’ç¸®å° */
.panel{padding:18px; font-size:1em;}
.panel h3{font-size:1.5em;}
.form-row{gap:8px;}

/* ãƒ˜ãƒƒãƒ€ãƒ¼ã‚‚èª¿æ•´ */
.config-header{
font-size: 0.9em;
gap: 8px;
padding-left: 24px;
}

/* å®šæ•°/è‡ªç”±ãƒœã‚¿ãƒ³ã®è¨­å®šè¡Œï¼ˆæ¨ªä¸¦ã³ã‚’ç¶­æŒã™ã‚‹è¨­å®šï¼‰ */
.form-row > div:first-child{ /* Index number */
width: 24px !important;
font-size: 1em !important;
flex-shrink: 0;
}
.form-row input[type="text"],
.form-row input[type="number"],
.form-row select{
padding: 10px;
font-size: 0.9em;
}
/* Tax/Roundã®ãƒ©ãƒ™ãƒ«ã¨å…¥åŠ›æ¬„ã¯ç¸¦ç©ã¿ */
.form-row:not(#buttonConfig .form-row):not(#freeConfig .form-row) {
flex-wrap: wrap;
}
.form-row:not(#buttonConfig .form-row):not(#freeConfig .form-row) > label {
min-width:100% !important;
margin-bottom: -4px;
}
.form-row input[type="number"]#taxInput,
.form-row select#roundMethod {
flex: 1 1 100%;
}
}
/* --- CSS END --- */
</style>
</head>
<body>
<div class="app">
<div class="header">
<div>
<div class="title">ç©ç®—é›»å“ï¼ˆçµ±åˆç‰ˆï¼‰</div>
<div class="sub">é»’åŸºèª¿ãƒ»24å®šæ•°ãƒ»è‡ªç”±å…¥åŠ›5ã¤ãƒ»ä¸¸ã‚è¨­å®š</div>
</div>
<div style="text-align:right; display:flex; gap:12px; align-items:center;">
<div style="text-align:right;">
<label for="rankSelector" class="sub" style="font-size:12px; display:block; text-align: left; margin-bottom: 2px;">ãƒ©ãƒ³ã‚¯:</label>
<select id="rankSelector" style="padding:4px 8px;border-radius:4px;background:#202327;color:#fff;border:1px solid rgba(255,255,255,0.2);font-size:14px;min-width: 60px;"></select>
</div>
<button id="openSettings" class="action-btn" style="padding:8px 10px;font-size:13px">âš™ è¨­å®š</button>
</div>
</div>

<div class="top">
<div class="left" id="stack"></div>

<div class="right">
<div style="display:flex;justify-content:space-between;align-items:center">
<div class="tot-label">ç¨æŠœåˆè¨ˆ</div>
<div class="tot-value" id="preTax">0 å††</div>
</div>
<div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px">
<div class="tot-label">æ¶ˆè²»ç¨ (<span id="taxRate">10</span>%)</div>
<div class="tot-value" id="tax">0 å††</div>
</div>
<div style="display:flex;justify-content:space-between;align-items:center;margin-top:12px">
<div class="tot-label">åˆè¨ˆï¼ˆç¨è¾¼ï¼‰</div>
<div class="tot-value" id="total">0 å††</div>
</div>
</div>
</div>

<div class="grid-wrap">
<div class="buttons" id="buttonsArea" aria-hidden="false"></div>
</div>

<div class="grid-wrap" style="margin-top:10px;">
<div class="buttons" id="controlBtnsArea">
</div>
</div>

<div class="free-group" aria-label="è‡ªç”±å…¥åŠ›ã‚°ãƒ«ãƒ¼ãƒ—" style="margin-top:10px;">
<div style="font-size:13px;color:var(--muted);">é‡‘é¡ã‚’å…¥åŠ›ã—ã¦ä¸‹ã®è©²å½“æ›ã‘ç‡ã®ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™</div>
<div class="free-row">
<input id="freeValue" class="free-input" type="number" placeholder="é‡‘é¡ã‚’å…¥åŠ›ï¼ˆå††ï¼‰" min="0" step="1" />
</div>
</div>

<div class="coeff-row" id="freeBtnsArea">
</div>

</div>

<div class="modal" id="modal">
<div class="panel">
<h3>è¨­å®š</h3>

<div class="form-row">
<label>æ¶ˆè²»ç¨ç‡ï¼ˆï¼…ï¼‰</label>
<input id="taxInput" type="number" min="0" step="0.1">
</div>

<div class="form-row">
<label>å°æ•°ç‚¹ä»¥ä¸‹ã®å‡¦ç†</label>
<select id="roundMethod">
<option value="floor">åˆ‡ã‚Šæ¨ã¦</option>
<option value="round">å››æ¨äº”å…¥</option>
<option value="ceil">åˆ‡ã‚Šä¸Šã’</option>
</select>
</div>

<div style="margin:16px 0;color:var(--muted)">å®šæ•°ãƒœã‚¿ãƒ³ï¼ˆ24å€‹ï¼‰ã®åå‰ã¨**ç¾åœ¨é¸æŠä¸­ã®ãƒ©ãƒ³ã‚¯ï¼ˆ<span id="currentRankDisplay">S</span>ï¼‰**ã®é‡‘é¡ã‚’ç·¨é›†ã—ã¦ãã ã•ã„ã€‚</div>
<div class="config-header">
<div style="flex: 3;">åå‰</div>
<div style="flex: 2; text-align: right;">é‡‘é¡ï¼ˆå††ï¼‰</div>
</div>
<div id="buttonConfig"></div>

<hr style="border-color:rgba(255,255,255,0.03);" />

<div style="margin:16px 0;color:var(--muted)">è‡ªç”±ãƒœã‚¿ãƒ³ï¼ˆ5å€‹ã¾ã§è¡¨ç¤ºå¯ï¼‰ - åå‰ã¨ä¿‚æ•°ã‚’ç·¨é›†ã—ã¦ãã ã•ã„ã€‚</div>
<div class="config-header">
<div style="flex: 3;">åå‰</div>
<div style="flex: 2; text-align: right;">ä¿‚æ•°</div>
</div>
<div id="freeConfig"></div>

<div style="display:flex;gap:16px;margin-top:24px;">
<button id="saveSettingsBtn" class="action-btn" style="background:#0b8a44;border:none; color: #fff;">ä¿å­˜</button>
<button id="closeModal" class="action-btn" style="background:#222;color:#fff">é–‰ã˜ã‚‹</button>
</div>

<hr style="border-color:rgba(255,255,255,0.03); margin-top: 24px;" />

<div style="margin:16px 0;color:var(--muted)">**è¨­å®šã®åŒæœŸãƒ»ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼ˆJSONãƒ•ã‚¡ã‚¤ãƒ«ï¼‰**</div>
<div style="display:flex;gap:16px;margin-top:8px;">
<button id="exportSettingsBtn" class="action-btn" style="background:#555;border:none; color: #fff; flex:1;">è¨­å®šã®ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ (JSON)</button>
<button id="importBtn" class="action-btn" style="background:#4070ff;border:none; color: #fff; flex:1;">è¨­å®šã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆ (JSON)</button>
<input type="file" id="importFile" accept=".json" style="display:none;" />
</div>

<hr style="border-color:rgba(255,255,255,0.03); margin-top: 24px;" />
<div style="margin:16px 0;color:var(--muted)">**å ±é…¬ãƒ©ãƒ³ã‚¯è¡¨ï¼ˆãƒ†ã‚­ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ï¼‰ã‹ã‚‰æ›´æ–°**</div>
<div class="small" style="margin-bottom: 8px; color: #ffeb3b;">
â€» PDFã‹ã‚‰ãƒ†ãƒ¼ãƒ–ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’ã‚³ãƒ”ãƒ¼ã—ã€ãƒ†ã‚­ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆCSV, ã‚¿ãƒ–åŒºåˆ‡ã‚Šï¼‰ã¨ã—ã¦ä¿å­˜ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ãŒå¿…è¦ã§ã™ã€‚
</div>
<div style="display:flex;gap:16px;margin-top:8px;">
<button id="importPriceTableBtn" class="action-btn" style="background:#00bcd4;border:none; color: #fff; flex:1;">ãƒ©ãƒ³ã‚¯è¡¨ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
<input type="file" id="importPriceTableFile" accept=".txt,.csv,.tsv" style="display:none;" />
</div>
<div style="margin-top:20px;font-size:1em;color:var(--muted)">
â€»Cã¯ç›´å‰ã®è¿½åŠ ã‚’å–ã‚Šæ¶ˆã—ã€ACã¯ç©ç®—ã‚’å…¨ã¦ã‚¯ãƒªã‚¢ã—ã¾ã™ã€‚
â€» å ±é…¬ãƒ©ãƒ³ã‚¯ã®è¿½åŠ ãƒ»å¤‰æ›´ã¯ã€HTMLãƒ•ã‚¡ã‚¤ãƒ«ã®`<script>`ã‚¿ã‚°å†…ã«ã‚ã‚‹`DEFAULT`å¤‰æ•°ã‚’ç›´æ¥ç·¨é›†ã—ã¦ãã ã•ã„ã€‚
</div>
</div>
</div>

<script>
/* ===== defaults & storage keys ===== */
// ğŸ’¡ PDFã®åˆ—é †ã«åˆã‚ã›ã¦Hã‹ã‚‰SSSã¾ã§ã®11ãƒ©ãƒ³ã‚¯ã«æ›´æ–°
const DEFAULT_RANKS = ["H", "G", "F", "E", "D", "C", "B", "A", "S", "SS", "SSS"];
const DEFAULT = {
taxRate: 10,
roundMethod: "floor",
currentRank: "S", // åˆæœŸè¡¨ç¤ºãƒ©ãƒ³ã‚¯
availableRanks: DEFAULT_RANKS,
buttons: [
// 1. å®šæœŸUP
{name:"å®šæœŸUP", prices:{H:6775, G:7462, F:7855, E:8149, D:8444, C:8836, B:9425, A:9524, S:9818, SS:10113, SSS:10211}},
// 2. å®šæœŸGP
{name:"å®šæœŸGP", prices:{H:8444, G:9327, F:9818, E:10211, D:10505, C:10996, B:11684, A:11880, S:12273, SS:12567, SSS:12764}},
// 3. æ™®é€šUP
{name:"æ™®é€šUP", prices:{H:7756, G:8542, F:9033, E:9327, D:9622, C:10113, B:10702, A:10898, S:11193, SS:11487, SSS:11684}},
// 4. æ™®é€šGP
{name:"æ™®é€šGP", prices:{H:9425, G:10407, F:10996, E:11389, D:11684, C:12273, B:13058, A:13255, S:13647, SS:14040, SSS:14236}},
// 5. éŸ³æ•™å‚™å“UP
{name:"éŸ³æ•™å‚™å“UP", prices:{H:6382, G:6382, F:6382, E:6382, D:6382, C:6382, B:6382, A:6382, S:6382, SS:6382, SSS:6382}},
// 6. éŸ³æ•™å‚™å“GP
{name:"éŸ³æ•™å‚™å“GP", prices:{H:7855, G:7855, F:7855, E:7855, D:7855, C:7855, B:7855, A:7855, S:7855, SS:7855, SSS:7855}},
// 7. ç´èª¿UP (æ–°å“/ä¸­å¤)
{name:"ç´èª¿UP (æ–°å“/ä¸­å¤)", prices:{H:5891, G:5891, F:5891, E:5891, D:5891, C:5891, B:5891, A:5891, S:5891, SS:5891, SSS:5891}},
// 8. ç´èª¿GP (æ–°å“/ä¸­å¤)
{name:"ç´èª¿GP (æ–°å“/ä¸­å¤)", prices:{H:8836, G:8836, F:8836, E:8836, D:8836, C:8836, B:8836, A:8836, S:8836, SS:8836, SSS:8836}},
// 9. åº—é ­UP (åå¤å±‹åº—)
{name:"åº—é ­UP (åå¤å±‹åº—)", prices:{H:6382, G:6382, F:6382, E:6382, D:6382, C:6382, B:6382, A:6382, S:6382, SS:6382, SSS:6382}},
// 10. åº—é ­GP (åå¤å±‹åº—)
{name:"åº—é ­GP (åå¤å±‹åº—)", prices:{H:7953, G:7953, F:7953, E:7953, D:7953, C:7953, B:7953, A:7953, S:7953, SS:7953, SSS:7953}},
// 11. åº—é ­UP (RPS) - è¿½åŠ 
{name:"åº—é ­UP (RPS)", prices:{H:6382, G:6382, F:6382, E:6382, D:6382, C:6382, B:6382, A:6382, S:6382, SS:6382, SSS:6382}},
// 12. åº—é ­GP (RPS)
{name:"åº—é ­GP (RPS)", prices:{H:8836, G:8836, F:8836, E:8836, D:8836, C:8836, B:8836, A:8836, S:8836, SS:8836, SSS:8836}},
// 13. å­¦æ ¡UP
{name:"å­¦æ ¡UP", prices:{H:4811, G:4811, F:4811, E:4811, D:5302, C:5302, B:5891, A:5891, S:5891, SS:5891, SSS:5891}},
// 14. å­¦æ ¡GP
{name:"å­¦æ ¡GP", prices:{H:5793, G:5793, F:5793, E:5793, D:6578, C:6578, B:7265, A:7265, S:7265, SS:7265, SSS:7265}},
// 15. å­¦æ ¡CF/S - è¿½åŠ 
{name:"å­¦æ ¡CF/S", prices:{H:6578, G:6578, F:7265, E:7265, D:7855, C:7855, B:8542, A:8542, S:8542, SS:8542, SSS:8542}},
// 16. å­¦æ ¡SW/B - è¿½åŠ 
{name:"å­¦æ ¡SW/B", prices:{H:6775, G:6775, F:7462, E:7462, D:8247, C:8247, B:8935, A:8935, S:8935, SS:8935, SSS:8935}},
// 17. ãƒ¤ãƒãƒãƒ›ãƒ¼ãƒ«
{name:"ãƒ¤ãƒãƒãƒ›ãƒ¼ãƒ«", prices:{H:12764, G:12764, F:12764, E:12764, D:12764, C:12764, B:12764, A:12764, S:12764, SS:12764, SSS:12764}},
// 18. æ—¥å½“
{name:"æ—¥å½“", prices:{H:13745, G:14727, F:15709, E:16691, D:17673, C:18655, B:19636, A:19636, S:19636, SS:19636, SSS:19636}},
// 19. å‡ºå¼µè²»3000
{name:"å‡ºå¼µè²»3000", prices:{H:2356, G:2356, F:2356, E:2356, D:2356, C:2356, B:2356, A:2356, S:2356, SS:2356, SSS:2356}},
// 20. å‡ºå¼µè²»3500
{name:"å‡ºå¼µè²»3500", prices:{H:2847, G:2847, F:2847, E:2847, D:2847, C:2847, B:2847, A:2847, S:2847, SS:2847, SSS:2847}},
// 21. å‡ºå¼µè²»4000
{name:"å‡ºå¼µè²»4000", prices:{H:3338, G:3338, F:3338, E:3338, D:3338, C:3338, B:3338, A:3338, S:3338, SS:3338, SSS:3338}}
],
freeButtons: [
{name:"ä¿®ç†(%)", coeff:0.8836}, // Sãƒ©ãƒ³ã‚¯ã®å€¤ (88.36%)
{name:"ã‚¯ãƒ¬ãƒ¼ãƒ ãƒ»ä¿å®ˆ(%)", coeff:0.6873}, // Sãƒ©ãƒ³ã‚¯ã®å€¤ (68.73%)
{name:"éƒ¨å“ä»£", coeff:1},
{name:"ç«‹ä¼šã„", coeff:0.864},
{name:"ã‚³ãƒ³ã‚µãƒ¼ãƒˆ(%)", coeff:0.7658}
]
};
const CFG_KEY = "rewardcalc_cfg_v_integrated_rank";
const ENTRIES_KEY = "rewardcalc_entries_v_integrated_rank";

/* ===== state ===== */
let cfg = JSON.parse(localStorage.getItem(CFG_KEY) || "null") || DEFAULT;
let entries = JSON.parse(localStorage.getItem(ENTRIES_KEY) || "[]");

// äº’æ›æ€§ãƒ»ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ­ã‚¸ãƒƒã‚¯
// (ä»¥å‰ã®ãƒœã‚¿ãƒ³æ•°ãŒå°‘ãªã„å ´åˆã«ã€æ–°ã—ã„ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šã‚’è¿½åŠ ã™ã‚‹)
if (cfg.buttons.length < DEFAULT.buttons.length) {
const startIdx = cfg.buttons.length;
for (let i = startIdx; i < DEFAULT.buttons.length; i++) {
cfg.buttons.push(DEFAULT.buttons[i]);
}
// freeButtonsã‚‚æ›´æ–°
if(cfg.freeButtons.length < DEFAULT.freeButtons.length) {
for (let i = cfg.freeButtons.length; i < DEFAULT.freeButtons.length; i++) {
cfg.freeButtons.push(DEFAULT.freeButtons[i]);
}
}
if (!cfg.availableRanks || !Array.isArray(cfg.availableRanks) || cfg.availableRanks.length !== DEFAULT_RANKS.length) {
cfg.availableRanks = DEFAULT.availableRanks;
}
saveCfg();
} else if(cfg.buttons.length > DEFAULT.buttons.length) {
// ä»¥å‰ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã§ãƒœã‚¿ãƒ³ã‚’ã‚«ã‚¹ã‚¿ãƒ è¿½åŠ ã—ã¦ã„ãŸå ´åˆã«å¯¾å¿œï¼ˆä»Šå›ã¯21å€‹ã§å›ºå®šï¼‰
cfg.buttons = cfg.buttons.slice(0, DEFAULT.buttons.length);
if(cfg.freeButtons.length > DEFAULT.freeButtons.length) {
cfg.freeButtons = cfg.freeButtons.slice(0, DEFAULT.freeButtons.length);
}
saveCfg();
}

/* ===== elems ===== */
const buttonsArea = document.getElementById("buttonsArea");
const controlBtnsArea = document.getElementById("controlBtnsArea");
const stack = document.getElementById("stack");
const preTaxEl = document.getElementById("preTax");
const taxEl = document.getElementById("tax");
const totalEl = document.getElementById("total");
const taxRateSpan = document.getElementById("taxRate");
const freeValue = document.getElementById("freeValue");
const freeBtnsArea = document.getElementById("freeBtnsArea");
const rankSelector = document.getElementById("rankSelector");

/* ===== helpers ===== */
function fmt(n){ return Number(n).toLocaleString() + " å††"; }
function toInt(v){ return Math.round(Number(v) || 0); }
// ã‚³ãƒ³ã‚µãƒ¼ãƒˆé–¢é€£ã®åç§°å¤‰æ›´ã«ä¼´ã„ã€ç‰¹æ®Šãªä¸¸ã‚å‡¦ç†ã¯å…¨ã¦å‰Šé™¤ã€‚
// PDFå˜ä¾¡ã¯æ—¢ã«å††æœªæº€ã®ç«¯æ•°ãŒãªã„ãŸã‚ã€ä¸¸ã‚å‡¦ç†ã¯ç¨è¾¼ã¿åˆè¨ˆã«ã®ã¿é©ç”¨ã€‚
function applyRoundMethod(value, method){
if(method === "ceil") return Math.ceil(value);
if(method === "round") return Math.round(value);
return Math.floor(value);
}
// é …ç›®ã”ã¨ã®ä¸¸ã‚å‡¦ç†ã¯å‰Šé™¤ã—ã€å—ã‘å–ã£ãŸå˜ä¾¡ã‚’ãã®ã¾ã¾ä½¿ç”¨
function roundItem(name, val){
return toInt(val);
}

function saveCfg(){ localStorage.setItem(CFG_KEY, JSON.stringify(cfg)); }
function saveEntries(){ localStorage.setItem(ENTRIES_KEY, JSON.stringify(entries)); }

function jumpToTop(){
stack.scrollTop = 0;
window.scrollTo(0, 0);
}

/* ===== rank selector ===== */
function renderRankSelector() {
if (!rankSelector) return;
rankSelector.innerHTML = "";
(cfg.availableRanks || DEFAULT_RANKS).forEach(rank => {
const option = document.createElement("option");
option.value = rank;
option.textContent = rank;
if (rank === cfg.currentRank) {
option.selected = true;
}
rankSelector.appendChild(option);
});

rankSelector.addEventListener("change", (ev) => {
cfg.currentRank = ev.target.value;
saveCfg();
renderButtons();
});
}


/* ===== render buttons grid (24 constants) ===== */
function renderButtons(){
buttonsArea.innerHTML = "";

const COLOR_LIGHT = 'linear-gradient(180deg, hsl(200, 85%, 90%), hsl(200, 85%, 80%))';
const COLOR_DARK = 'linear-gradient(180deg, hsl(200, 70%, 60%), hsl(200, 70%, 50%))';

for(let i=0;i<24;i++){
const b = cfg.buttons[i];

// è¨­å®šé …ç›®ãŒ21å€‹ãªã®ã§ã€22ç•ªç›®ä»¥é™ã¯ç©ºãƒœã‚¿ãƒ³ã«ã™ã‚‹
if (!b) {
const emptyBtn = document.createElement("div");
emptyBtn.className = "btn-placeholder"; // CSSã§é€éçš„ã«è¨­å®š
buttonsArea.appendChild(emptyBtn);
continue;
}

const col = i % 4;
const btn = document.createElement("button");
btn.className = "btn";

const isDark = (col % 2 === 0);
btn.style.background = isDark ? COLOR_DARK : COLOR_LIGHT;
btn.style.color = isDark ? '#fff' : 'var(--dark-btn)';

const currentPrice = (b.prices && b.prices[cfg.currentRank] !== undefined) ? b.prices[cfg.currentRank] : 0;

const priceColor = isDark ? 'rgba(255,255,255,0.9)' : 'rgba(0,0,0,0.8)';
btn.innerHTML = `<div style="font-size:14px">${escapeHtml(b.name)}</div><div style="font-size:13px;margin-top:6px;color:${priceColor}">${currentPrice ? currentPrice.toLocaleString()+' å††':''}</div>`;
btn.addEventListener("click", ()=> {
const displayName = b.name || "ç„¡å";
const priceValue = (b.prices && b.prices[cfg.currentRank] !== undefined) ? b.prices[cfg.currentRank] : 0;
const price = roundItem(b.name, Number(priceValue||0)); // ä»Šå›ã¯roundItemã¯toIntã¨åŒã˜
addEntry({type:"preset", name:displayName, price});
setTimeout(jumpToTop, 300);
});

buttonsArea.appendChild(btn);
}
}

/* ===== render control buttons (C/AC) ===== */
function renderControlButtons() {
controlBtnsArea.innerHTML = "";

const empty1 = document.createElement("div");
empty1.className = "btn-placeholder";

const empty2 = document.createElement("div");
empty2.className = "btn-placeholder";

const btnC = document.createElement("button");
btnC.className = "btn dark";
btnC.innerHTML = `<div style="font-size:16px;color:#fff;">C</div><div style="font-size:12px;margin-top:6px;color:#fff">ç›´å‰ã®å–ã‚Šæ¶ˆã—</div>`;
btnC.addEventListener("click", ()=> {
if(entries.length>0) entries.pop();
saveEntries(); renderStack(); renderTotals();
setTimeout(jumpToTop, 100);
});

const btnAC = document.createElement("button");
btnAC.className = "btn ac-dark";
btnAC.innerHTML = `<div style="font-size:14px;color:#fff;">AC</div><div style="font-size:12px;margin-top:6px;color:#fff">å…¨ã¦ã‚¯ãƒªã‚¢</div>`;
btnAC.addEventListener("click", ()=> {
entries=[];
saveEntries();
renderStack();
renderTotals();
document.getElementById("freeValue").value = "";
setTimeout(jumpToTop, 100);
});

controlBtnsArea.appendChild(empty1);
controlBtnsArea.appendChild(empty2);
controlBtnsArea.appendChild(btnC);
controlBtnsArea.appendChild(btnAC);
}

/* ===== render free buttons ===== */
function renderFreeButtons(){
freeBtnsArea.innerHTML = "";
// æœ€å¤§5å€‹ã¾ã§è¡¨ç¤ºï¼ˆCSSã§4åˆ—ã«ãªã£ã¦ã„ã‚‹ãŒã€5å€‹è¨­å®šã—ãŸå ´åˆã¯æ¬¡ã®è¡Œã«è¡¨ç¤ºã•ã‚Œã‚‹ï¼‰
cfg.freeButtons.slice(0, 5).forEach((fb, idx)=>{
const b = document.createElement("button");
b.className = "coeff";
b.innerHTML = `<div style="font-size:14px">${escapeHtml(fb.name)}</div><div style="font-size:13px;margin-top:6px;color:var(--dark-btn)">Ã—${fb.coeff}</div>`;
b.addEventListener("click", ()=>{
const v = toInt(freeValue.value);
if(!v){ alert("é‡‘é¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆå††ï¼‰ã€‚"); return; }
const raw = v * Number(fb.coeff);
const price = roundItem(fb.name, raw);
addEntry({type:"free", name:fb.name, price});
freeValue.value = "";
setTimeout(jumpToTop, 300);
});
freeBtnsArea.appendChild(b);
});
}

/* ===== stack rendering, totals, addEntry (unchanged) ===== */
function renderStack(){
stack.innerHTML = "";
if(entries.length === 0){
const p = document.createElement("div");
p.className = "small";
p.style.padding="8px";
p.textContent = "ã¾ã é …ç›®ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚";
stack.appendChild(p);
return;
}
entries.forEach((e, i)=>{
const row = document.createElement("div");
row.className = "entry";
row.innerHTML = `<div style="display:flex;gap:10px;align-items:center"><div class="label">${escapeHtml(e.name)}</div><div class="small" style="color:var(--muted);font-size:12px">${e.type==="free" ? "ï¼ˆè‡ªç”±å…¥åŠ›ï¼‰": ""}</div></div><div style="display:flex;align-items:center"><div class="price">${Number(e.price).toLocaleString()} å††</div><button class="removeBtn" data-i="${i}">Ã—</button></div>`;
stack.appendChild(row);
});
stack.querySelectorAll(".removeBtn").forEach(btn=>{
btn.addEventListener("click", (ev)=>{
const idx = Number(ev.currentTarget.dataset.i);
entries.splice(idx,1);
saveEntries();
renderStack();
renderTotals();
setTimeout(jumpToTop, 100);
});
});
}

function renderTotals(){
let pre = 0;
entries.forEach(e=> pre += Number(e.price||0));
const taxRate = Number(cfg.taxRate || 0);
// ç¨é¡ã®è¨ˆç®—ã¨ä¸¸ã‚ã¯ã“ã“ã§å®Ÿè¡Œ
const tax = applyRoundMethod(pre * taxRate / 100, cfg.roundMethod || "floor");
const tot = pre + tax;
preTaxEl.textContent = fmt(pre);
taxEl.textContent = fmt(tax);
totalEl.textContent = fmt(tot);
taxRateSpan.textContent = taxRate;
}

function addEntry(item){
item.price = toInt(item.price);
item.price = roundItem(item.name, item.price); // ä»Šå›ã¯toIntã¨åŒã˜
entries.push(item);
saveEntries();
renderStack();
renderTotals();
}
/* ===== end stack rendering, totals, addEntry (unchanged) ===== */


/* settings modal logic */
const modal = document.getElementById("modal");
document.getElementById("openSettings").addEventListener("click", openSettings);
document.getElementById("closeModal").addEventListener("click", ()=>{ modal.style.display="none"; document.body.style.overflow=""; });

function openSettings(){
modal.style.display = "flex";
document.body.style.overflow = "hidden";
document.getElementById("taxInput").value = cfg.taxRate || 0;
document.getElementById("roundMethod").value = cfg.roundMethod || "floor";

document.getElementById("currentRankDisplay").textContent = cfg.currentRank;

renderButtonConfig();
renderFreeConfig();
}

function renderButtonConfig(){
const container = document.getElementById("buttonConfig");
container.innerHTML = "";
const currentRank = cfg.currentRank;

// å­˜åœ¨ã™ã‚‹ãƒœã‚¿ãƒ³ã®ã¿è¡¨ç¤º
cfg.buttons.forEach((b,i)=>{
const currentPrice = (b.prices && b.prices[currentRank] !== undefined) ? b.prices[currentRank] : 0;

const row = document.createElement("div");
row.className = "form-row";
row.innerHTML = `<div style="width:36px;color:var(--muted);font-size:1.1em;flex-shrink:0;">${i+1}</div>
<input id="bn${i}" type="text" value="${escapeHtml(b.name)}">
<input id="bv${i}" type="number" value="${currentPrice}" min="0">`;
container.appendChild(row);
});
}

function renderFreeConfig(){
const container = document.getElementById("freeConfig");
container.innerHTML = "";
// 5å€‹ã¾ã§è¡¨ç¤ºï¼ˆè¨­å®šãƒœã‚¿ãƒ³ãŒå¤šã™ãã‚‹å ´åˆã¯ç¸¦ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã§å¯¾å¿œï¼‰
cfg.freeButtons.forEach((f,i)=>{
const row = document.createElement("div");
row.className = "form-row";
row.innerHTML = `<div style="width:36px;color:var(--muted);font-size:1.1em;flex-shrink:0;">${i+1}</div>
<input id="fn${i}" type="text" value="${escapeHtml(f.name)}">
<input id="fc${i}" type="number" value="${f.coeff||1}" step="0.0001">`;
container.appendChild(row);
});
}

document.getElementById("saveSettingsBtn").addEventListener("click", ()=>{
const tr = Number(document.getElementById("taxInput").value || 0);
cfg.taxRate = tr;
cfg.roundMethod = document.getElementById("roundMethod").value || "floor";

const currentRank = cfg.currentRank;
cfg.buttons.forEach((b,i)=>{
const nameEl = document.getElementById("bn"+i);
const valEl = document.getElementById("bv"+i);
if(nameEl) b.name = nameEl.value || b.name;
if(valEl) {
if (!b.prices) b.prices = {};
b.prices[currentRank] = Number(valEl.value) || 0;
}
});

cfg.freeButtons.forEach((f,i)=>{
const nameEl = document.getElementById("fn"+i);
const valEl = document.getElementById("fc"+i);
if(nameEl) f.name = nameEl.value || f.name;
if(valEl) f.coeff = Number(valEl.value) || 1;
});

saveCfg();
renderButtons();
renderControlButtons();
renderFreeButtons();
renderTotals();
modal.style.display = "none";
document.body.style.overflow = "";
});

/* ğŸ’¡ JSON import/export config */
document.getElementById("importBtn").addEventListener("click", ()=> document.getElementById("importFile").click());
document.getElementById("importFile").addEventListener("change", (ev)=>{
const f = ev.target.files[0]; if(!f) return;
const r = new FileReader();
r.onload = e=>{
try{
const data = JSON.parse(e.target.result);
let importedCfg = data;
if(data.cfg){ importedCfg = data.cfg; }

if(!importedCfg || !Array.isArray(importedCfg.buttons) || !Array.isArray(importedCfg.freeButtons)){
alert("èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚");
return;
}

// ãƒœã‚¿ãƒ³æ•°ãŒè¶³ã‚Šãªã„å ´åˆã¯DEFAULTã‹ã‚‰è£œå®Œ
if (importedCfg.buttons.length < DEFAULT.buttons.length) {
const startIdx = importedCfg.buttons.length;
for (let i = startIdx; i < DEFAULT.buttons.length; i++) {
importedCfg.buttons.push(DEFAULT.buttons[i]);
}
}
if(importedCfg.freeButtons.length < DEFAULT.freeButtons.length) {
const startIdx = importedCfg.freeButtons.length;
for (let i = importedCfg.freeButtons.length; i < DEFAULT.freeButtons.length; i++) {
importedCfg.freeButtons.push(DEFAULT.freeButtons[i]);
}
}
if(!importedCfg.availableRanks || !Array.isArray(importedCfg.availableRanks)){
importedCfg.availableRanks = DEFAULT.availableRanks;
}

cfg = Object.assign({}, cfg, importedCfg);

saveCfg();
renderRankSelector();
renderButtons();
renderButtonConfig();
renderFreeButtons();
renderFreeConfig();
renderTotals();

alert("è¨­å®šã‚’æ­£å¸¸ã«èª­ã¿è¾¼ã¿ã¾ã—ãŸã€‚");
}catch(err){
alert("èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ãƒ•ã‚¡ã‚¤ãƒ«ã®å†…å®¹ãŒä¸æ­£ã§ã™ã€‚\n" + err.message)
}
ev.target.value = '';
};
r.readAsText(f,"utf-8");
});

document.getElementById("exportSettingsBtn").addEventListener("click", ()=>{
const blob = new Blob([JSON.stringify(cfg,null,2)], {type:"application/json"});
const a = document.createElement("a");
a.href = URL.createObjectURL(blob);
a.download = `rewardcfg_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.json`;
a.click();
alert("è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã‚’é–‹å§‹ã—ã¾ã—ãŸã€‚");
});
/* ğŸ’¡ end JSON import/export config */

/* ğŸ’¡ ãƒ©ãƒ³ã‚¯è¡¨ï¼ˆãƒ†ã‚­ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ï¼‰ã‚¤ãƒ³ãƒãƒ¼ãƒˆæ©Ÿèƒ½ */
document.getElementById("importPriceTableBtn").addEventListener("click", ()=> document.getElementById("importPriceTableFile").click());
document.getElementById("importPriceTableFile").addEventListener("change", importPriceTable);

function importPriceTable(ev){
const f = ev.target.files[0]; if(!f) return;

// 1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ãƒ©ãƒ³ã‚¯ã®åˆ—é †ã‚’å–å¾—
const rankInput = prompt(
"ã‚¤ãƒ³ãƒãƒ¼ãƒˆã™ã‚‹ãƒ©ãƒ³ã‚¯åã‚’ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼ˆä¾‹: H,G,F,E,D,C,B,A,S,SS,SSS,é¡§å®¢è«‹æ±‚ï¼‰ã§ã€ãƒ•ã‚¡ã‚¤ãƒ«å†…ã®åˆ—é †ã«å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚\n\nâ€»ã“ã®å…¥åŠ›ã¯è¨­å®šã«ä¿å­˜ã•ã‚Œã€ä»Šå¾Œã®ãƒ©ãƒ³ã‚¯ç·¨é›†ã®åŸºæº–ã¨ãªã‚Šã¾ã™ã€‚",
(cfg.availableRanks || DEFAULT_RANKS).join(',')
);
if (!rankInput) {
ev.target.value = '';
return;
}
const newRanks = rankInput.split(',').map(r => r.trim()).filter(r => r.length > 0);
if(newRanks.length === 0){
alert("ãƒ©ãƒ³ã‚¯ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚");
ev.target.value = '';
return;
}

const r = new FileReader();
r.onload = e=>{
try{
const textContent = e.target.result;
const updateCount = parsePriceTableData(textContent, newRanks);

// æˆåŠŸã—ãŸã‚‰ãƒ©ãƒ³ã‚¯è¨­å®šã‚’æ›´æ–°
cfg.availableRanks = newRanks;
cfg.currentRank = newRanks.includes(DEFAULT.currentRank) ? DEFAULT.currentRank : newRanks[0] || DEFAULT.currentRank;
saveCfg();

renderRankSelector();
renderButtons();
renderButtonConfig();

alert(`ä¾¡æ ¼ãƒ‡ãƒ¼ã‚¿ã‚’æ­£å¸¸ã«èª­ã¿è¾¼ã¿ã¾ã—ãŸã€‚\n${updateCount}å€‹ã®ãƒœã‚¿ãƒ³ã®ä¾¡æ ¼ãŒæ›´æ–°ã•ã‚Œã¾ã—ãŸã€‚\nç¾åœ¨ã®ãƒ©ãƒ³ã‚¯ã¯ã€Œ${cfg.currentRank}ã€ã«è¨­å®šã•ã‚Œã¾ã—ãŸã€‚`);
}catch(err){
alert("ä¾¡æ ¼ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ãƒ•ã‚¡ã‚¤ãƒ«ã®å†…å®¹ãŒä¸æ­£ã§ã™ã€‚\n" + err.message)
}
ev.target.value = '';
};
r.readAsText(f,"utf-8");
}

function parsePriceTableData(textContent, newRanks){
const lines = textContent.trim().split('\n').filter(line => line.trim() !== '');
let updatedButtonsCount = 0;

lines.forEach(line => {
// ã‚¿ãƒ–ã¾ãŸã¯ã‚³ãƒ³ãƒã§åˆ†å‰²ã‚’è©¦ã¿ã‚‹
let columns = line.split('\t');
if (columns.length < 2 || columns.length < newRanks.length + 1) {
columns = line.split(',');
}
// æœ€åˆã®åˆ—(é …ç›®å)ã¨å°‘ãªãã¨ã‚‚ä¸€ã¤ã®ãƒ©ãƒ³ã‚¯ä¾¡æ ¼ãŒã‚ã‚‹ã“ã¨ã‚’ç¢ºèª
if (columns.length < 2) return;

const importedName = columns[0].trim();
const importedPrices = columns.slice(1);

// æ—¢å­˜ã®ãƒœã‚¿ãƒ³è¨­å®šã§åå‰ãŒä¸€è‡´ã™ã‚‹ã‚‚ã®ã‚’æ¢ã™
const button = cfg.buttons.find(b => b.name.trim() === importedName);

if (button) {
let prices = button.prices || {};
let isUpdated = false;

newRanks.forEach((rank, index) => {
// ã‚¤ãƒ³ãƒãƒ¼ãƒˆã•ã‚ŒãŸä¾¡æ ¼ãƒ‡ãƒ¼ã‚¿ã¯ newRanksã®æ¬¡ã«ç¶šããŸã‚ã€index+1ç•ªç›®ã‚’è¦‹ã‚‹
if (importedPrices[index] !== undefined) {
// ã‚«ãƒ³ãƒã‚’å‰Šé™¤ã—ã¦æ•°å€¤ã«å¤‰æ›
const priceStr = String(importedPrices[index]).trim().replace(/,/g, '');
const price = toInt(priceStr);

// æœ‰åŠ¹ãªæ•°å€¤ï¼ˆ0å††å«ã‚€ï¼‰ã§ã‚ã‚Œã°æ›´æ–°
if (!isNaN(price) && (price > 0 || priceStr === '0')) {
prices[rank] = price;
isUpdated = true;
}
}
});

if(isUpdated){
button.prices = prices;
updatedButtonsCount++;
}
}
});

return updatedButtonsCount;
}
/* ğŸ’¡ end ãƒ©ãƒ³ã‚¯è¡¨ï¼ˆãƒ†ã‚­ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ï¼‰ã‚¤ãƒ³ãƒãƒ¼ãƒˆæ©Ÿèƒ½ */


/* init */
renderRankSelector();
renderButtons();
renderControlButtons();
renderFreeButtons();
renderStack();
renderTotals();

/* helpers */
function escapeHtml(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/"/g,'&quot;'); }
</script>
</body>
</html>
